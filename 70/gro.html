<!doctype html>
<html lang=ru>
<meta charset=UTF-8>
<meta content="width=device-width,initial-scale=1"name=viewport>
<title>–ì–†–û</title>
<meta content="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–∫–∞–º –ì–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–±–∏–≤–æ—á–Ω–æ–π –æ—Å–Ω–æ–≤—ã (–ì–†–û) –¥–ª—è –ò—Ä–∫—É—Ç—Å–∫–æ–≥–æ –∑–∞–≤–æ–¥–∞ –ø–æ–ª–∏–º–µ—Ä–æ–≤."name=description>
<link href=/favicon.png rel=icon type=image/png>
<style>
:root{--primary-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Ubuntu","Helvetica Neue",Arial,sans-serif;--mono-font:"SF Mono","Monaco",Consolas,"Lucida Console","Roboto Mono","Droid Sans Mono","Ubuntu Mono","Liberation Mono","DejaVu Sans Mono","Courier New",monospace;--container-max-width:900px;--spacing-unit:10px;--background-color:#fff;--text-color:#000;--button-background-color:#eee;--button-hover-background-color:#f0f0f0}@media (prefers-color-scheme:dark){:root{--background-color:#1e1e1e;--text-color:#f5f5f5;--button-background-color:#333;--button-hover-background-color:#444}}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:var(--primary-font);background:var(--background-color);color:var(--text-color);line-height:1.6;padding:var(--spacing-unit);transition:background-color .3s ease,color .3s ease}.page-container{max-width:var(--container-max-width);margin:calc(var(--spacing-unit)*2) auto;padding:0 calc(var(--spacing-unit)*2)}h1{font-size:2rem;margin-bottom:calc(var(--spacing-unit)*2)}.breadcrumbs{font-size:1.1rem;margin-bottom:calc(var(--spacing-unit)*1.5)}.breadcrumbs ol{list-style:none;padding-left:0;margin:0;display:flex;flex-wrap:wrap;align-items:center}.breadcrumbs li a{text-decoration:none;color:var(--text-color)}.breadcrumbs li a:hover{text-decoration:underline}.breadcrumbs li+li::before{content:'>';margin:0 calc(var(--spacing-unit)*.8);color:var(--text-color);opacity:.6}.breadcrumbs li.current{font-weight:400;color:var(--text-color);opacity:.7}.b{display:inline-block;text-decoration:none;text-align:left;font-family:inherit;font-size:1.2rem;padding:var(--spacing-unit) calc(var(--spacing-unit)*2);border-radius:20px;cursor:pointer;font-weight:600;border:0;color:var(--text-color);background-color:var(--button-background-color);transition:background-color .2s ease}.b:hover{background-color:var(--button-hover-background-color)}section{margin-bottom:calc(var(--spacing-unit)*1.5)}section>div{display:flex;flex-wrap:wrap;gap:var(--spacing-unit)}section>div.vertical{flex-direction:column;align-items:flex-start}section>h2{font-weight:500;margin-bottom:var(--spacing-unit);font-size:1.5rem}@media (max-width:425px){html{font-size:15px}:root{--spacing-unit:9px}}.controls-container{max-width:900px;margin:20px 0;padding:15px;border:1px solid #eee;border-radius:8px;background-color:#f9f9f9;display:flex;flex-direction:column;gap:15px;font-family:var(--primary-font)}.control-row{display:flex;align-items:center;flex-wrap:wrap;gap:10px;width:100%}.input-control-row{gap:5px}.control-label{font-size:.95em;color:var(--text-color);margin-right:5px;white-space:nowrap}#search-input,.manual-coord-input{padding:10px 12px;border:1px solid #ccc;border-radius:4px;font-size:1em;font-family:var(--primary-font);box-sizing:border-box;text-align:left;background-color:var(--background-color);color:var(--text-color)}#search-input{min-width:250px}.manual-coord-input{width:180px}.coord-toggle,.ignore-chars-toggle,.note-toggle,.search-mode-toggle,.separator-toggle{padding:5px;border:1px solid #ccc;border-radius:20px;display:inline-flex;background-color:#eee}.coord-toggle input[type=radio],.ignore-chars-toggle input[type=radio],.note-toggle input[type=radio],.search-mode-toggle input[type=radio],.separator-toggle input[type=radio]{display:none}.coord-toggle label,.ignore-chars-toggle label,.note-toggle label,.search-mode-toggle label,.separator-toggle label{display:inline-block;padding:8px 15px;cursor:pointer;border-radius:18px;transition:background-color .3s ease,color .3s ease;color:#555;font-family:var(--primary-font);font-size:.9em;white-space:nowrap}.coord-toggle input[type=radio]:checked+label,.ignore-chars-toggle input[type=radio]:checked+label,.note-toggle input[type=radio]:checked+label,.search-mode-toggle input[type=radio]:checked+label,.separator-toggle input[type=radio]:checked+label{background-color:#007bff;color:#fff}#airtable-data-container{max-width:900px;margin:20px 0}#airtable-message-state{color:var(--text-color);opacity:.8;font-family:var(--primary-font);padding:20px;text-align:left}#airtable-message-state.error{color:#d8000c;background-color:#ffd2d2;border:1px solid #d8000c;padding:10px;border-radius:5px;display:inline-block;text-align:left;opacity:1}#output-list{font-family:var(--mono-font),var(--primary-font);text-align:left;background-color:#fdfdfd;border:1px solid #eee;padding:20px;margin-top:15px;border-radius:5px;line-height:1.6;overflow-x:auto;color:var(--text-color)}.output-line{margin-bottom:2px;padding-bottom:3px;border-bottom:1px dotted #eee}.point-link{cursor:pointer;text-decoration:underline;color:#007bff;font-weight:700}.point-link:hover{color:#0056b3}.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:1000}.popup-content{background-color:var(--background-color);padding:30px;border-radius:8px;max-width:800px;max-height:80vh;overflow-y:auto;position:relative;font-family:var(--mono-font),var(--primary-font);text-align:left;box-shadow:0 4px 15px rgba(0,0,0,.2);color:var(--text-color)}.popup-close-btn{position:absolute;top:10px;right:15px;font-size:24px;cursor:pointer;background:0 0;border:none;color:var(--text-color);opacity:.7}.popup-close-btn:hover{opacity:1}#nearby-list{margin-top:15px;line-height:1.7}#nearby-list .nearby-item{margin-bottom:5px}#nearby-list .nearby-distance{font-weight:700;color:var(--text-color);opacity:.9;display:inline-block;min-width:60px;text-align:right;margin-right:10px}#nearby-list .reference-point{font-weight:700;margin-bottom:10px;border-bottom:1px solid #ccc;padding-bottom:5px}#manual-conversion-result-x,#manual-conversion-result-y{font-weight:700;margin-left:5px;min-width:120px;display:inline-block;font-family:var(--mono-font),var(--primary-font)}@media (prefers-color-scheme:dark){.controls-container{border-color:#444;background-color:#2b2b2b}#search-input,.manual-coord-input{border-color:#555}.coord-toggle,.ignore-chars-toggle,.note-toggle,.search-mode-toggle,.separator-toggle{border-color:#555;background-color:#3a3a3a}.coord-toggle label,.ignore-chars-toggle label,.note-toggle label,.search-mode-toggle label,.separator-toggle label{color:#ccc}#output-list{background-color:#252525;border-color:#444}.output-line{border-bottom-color:#444}#nearby-list .reference-point{border-bottom-color:#555}}
</style>
<div class=page-container>
    <nav aria-label=breadcrumb class=breadcrumbs>
        <ol>
            <li><a href=/index.html>–ì–ª–∞–≤–Ω–∞—è</a>
            <li><a href=/70/index.html>–ò–ó–ü</a>
            <li aria-current=page class=current>–ì–†–û
        </ol>
    </nav>
    <h1>–ì–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–∏–≤–æ—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞</h1>
    <h2>–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫</h2>
    <div class=controls-container>
        <div class=control-row><span class=control-label>–¶–µ–ª–µ–≤–∞—è –°–ö:</span>
            <div class=coord-toggle><input id=toggle-izp name=coord-system type=radio value=izp checked> <label for=toggle-izp>–ò–ó–ü</label> <input id=toggle-msk name=coord-system type=radio value=msk> <label for=toggle-msk>–ú–°–ö</label> <input id=toggle-gfu name=coord-system type=radio value=gfu> <label for=toggle-gfu>–ì–§–£</label></div>
        </div>
        <div class=control-row><span class=control-label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</span>
            <div class=note-toggle><input id=note-on name=note-mode type=radio value=on checked> <label for=note-on>–í–∫–ª</label> <input id=note-off name=note-mode type=radio value=off> <label for=note-off>–í—ã–∫–ª</label></div>
        </div>
        <div class=control-row><span class=control-label>–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ:</span>
            <div class=search-mode-toggle><input id=search-contains name=search-mode type=radio value=contains checked> <label for=search-contains>–°–æ–¥–µ—Ä–∂–∏—Ç</label> <input id=search-exact name=search-mode type=radio value=exact> <label for=search-exact>–¢–æ—á–Ω–æ</label></div>
        </div>
        <div class=control-row><span class=control-label>–ò–≥–Ω–æ—Ä. —Å–ø–µ—Ü—Å–∏–º–≤.:</span>
            <div class=ignore-chars-toggle><input id=ignore-off name=ignore-mode type=radio value=off checked> <label for=ignore-off>–í—ã–∫–ª</label> <input id=ignore-on name=ignore-mode type=radio value=on> <label for=ignore-on>–í–∫–ª</label></div>
        </div>
        <div class="control-row"><span class="control-label">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:</span>
            <div class="separator-toggle"><input id="separator-comma" name="separator-mode" type="radio" value="comma" checked> <label for="separator-comma">–ó–∞–ø—è—Ç–∞—è</label> <input id="separator-space" name="separator-mode" type="radio" value="space"> <label for="separator-space">–ü—Ä–æ–±–µ–ª</label></div>
        </div>
        <div class=control-row><input id=search-input placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."></div>
    </div>
    <div id=airtable-data-container>
        <div id=airtable-message-state>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...</div>
        <div id=output-list style=display:none></div>
    </div>
    <div class=popup-overlay id=nearby-popup style=display:none>
        <div class=popup-content><button class=popup-close-btn onclick=closeNearbyPopup()>√ó</button>
            <h3>–¢–æ—á–∫–∏ —Ä—è–¥–æ–º (–¥–æ 300–º):</h3>
            <div id=nearby-list></div>
        </div>
    </div>
    <section>
        <h2>–†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏</h2>
        <div><a href="https://docs.google.com/spreadsheets/d/18wTwF7jmr3uSAP8ak1PrI6lTlzzrkZwjhXwf2Mmr41Y/edit?usp=sharing"class=b>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã</a> <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTa3l-bUfZwy3iCNzVKmawZ_dApKSqMm6yuddAzP3eIkLp5m7zuHydF2UdSkUxKwW0CntEv6EBCxFf7/pub?gid=1125461087&single=true&output=csv"class=b>–°–∫–∞—á–∞—Ç—å CSV</a></div>
    </section>
    <section>
        <h2>–ü–µ—Ä–µ–≤–æ–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</h2>
        <div class=controls-container>
            <div class=control-row><span class=control-label>–ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</span>
                <div class=coord-toggle><input id=manual-source-izp name=manual-source-system type=radio value=izp checked> <label for=manual-source-izp>–ò–ó–ü</label> <input id=manual-source-msk name=manual-source-system type=radio value=msk> <label for=manual-source-msk>–ú–°–ö</label> <input id=manual-source-gfu name=manual-source-system type=radio value=gfu> <label for=manual-source-gfu>–ì–§–£</label></div>
            </div>
            <div class="control-row input-control-row"><label for=manual-coord-x class=control-label>X (–°–µ–≤–µ—Ä):</label> <input id=manual-coord-x placeholder="–í–≤–µ–¥–∏—Ç–µ X"class=manual-coord-input inputmode=decimal></div>
            <div class="control-row input-control-row"><label for=manual-coord-y class=control-label>Y (–í–æ—Å—Ç–æ–∫):</label> <input id=manual-coord-y placeholder="–í–≤–µ–¥–∏—Ç–µ Y"class=manual-coord-input inputmode=decimal></div>
            <div class=control-row><span class=control-label>–¶–µ–ª–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:</span>
                <div class=coord-toggle><input id=manual-target-izp name=manual-target-system type=radio value=izp> <label for=manual-target-izp>–ò–ó–ü</label> <input id=manual-target-msk name=manual-target-system type=radio value=msk checked> <label for=manual-target-msk>–ú–°–ö</label> <input id=manual-target-gfu name=manual-target-system type=radio value=gfu> <label for=manual-target-gfu>–ì–§–£</label></div>
            </div>
            <div class=control-row><span class=control-label>–†–µ–∑—É–ª—å—Ç–∞—Ç:</span>
                <div>X: <span id=manual-conversion-result-x>---</span> Y: <span id=manual-conversion-result-y>---</span></div>
            </div>
        </div>
    </section>
</div>
<script src="/70/lib/proj4.js"></script> 
<script>
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º EPSG:28418 –¥–ª—è proj4
if (typeof proj4 !== 'undefined') {
    proj4.defs("EPSG:28418", "+proj=tmerc +lat_0=0 +lon_0=105 +k=1 +x_0=18500000 +y_0=0 +ellps=krass +towgs84=23.92,-141.27,-80.9,-0,0.35,0.82,-0.12 +units=m +no_defs");
} else {
    console.error("proj4.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
}

const GOOGLE_SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vTa3l-bUfZwy3iCNzVKmawZ_dApKSqMm6yuddAzP3eIkLp5m7zuHydF2UdSkUxKwW0CntEv6EBCxFf7/pub?gid=1125461087&single=true&output=csv';
const BASE_X_FIELD_NAME='Xraw';
const BASE_Y_FIELD_NAME='Yraw';
const COL_INDEX={CoordSystem:0,Point:1,Xraw:2,Yraw:3,H:4,Info:5};
const DEBOUNCE_DELAY=400;
const MAX_NEARBY_DISTANCE=300;
const X0_SS_IN_MSK=6305600;
const Y0_SS_IN_MSK=557800;
const K1_SS=0.8048621495;
const K2_SS=0.5934618103;
const X0_GFU_IN_MSK=6301571.65;
const Y0_GFU_IN_MSK=561132.43;
const K1_GFU=0.4303677383;
const K2_GFU=0.90265363489;
let fullDatabaseCache=[];
let currentDisplayRecords=[];
let currentCoordMode='izp';
let isNoteVisible=!0;
let shouldIgnoreChars=!1;
let debounceTimer;
let isLoading=!1;
let currentSeparatorChar=',';
const outputContainer=document.getElementById('output-list');
const messageState=document.getElementById('airtable-message-state');
const searchCoordToggleButtons=document.querySelectorAll('input[name="coord-system"]');
const searchInput=document.getElementById('search-input');
const nearbyPopup=document.getElementById('nearby-popup');
const nearbyListContainer=document.getElementById('nearby-list');
let closePopupButton;
let manualSourceSystemRadios,manualTargetSystemRadios;
let manualCoordXInput,manualCoordYInput;
let manualResultXSpan,manualResultYSpan;

function formatCoordinate(value){if(value===null||typeof value==='undefined'||isNaN(value)){return'N/A'}return parseFloat(value).toFixed(3)}
function normalizePointValue(str){if(!str)return'';return str.toLowerCase().replace(/[\._,\-]/g,'')}
function convertMskToLocalX(xMsk,yMsk,X0_Local_IN_MSK,Y0_Local_IN_MSK,K1_Local,K2_Local){if(isNaN(xMsk)||isNaN(yMsk))return NaN;return(xMsk-X0_Local_IN_MSK)*K1_Local+(yMsk-Y0_Local_IN_MSK)*K2_Local}
function convertMskToLocalY(xMsk,yMsk,X0_Local_IN_MSK,Y0_Local_IN_MSK,K1_Local,K2_Local){if(isNaN(xMsk)||isNaN(yMsk))return NaN;return(yMsk-Y0_Local_IN_MSK)*K1_Local-(xMsk-X0_Local_IN_MSK)*K2_Local}
function convertLocalToMskX(xLocal,yLocal,X0_Local_IN_MSK,Y0_Local_IN_MSK,K1_Local,K2_Local){if(isNaN(xLocal)||isNaN(yLocal))return NaN;return X0_Local_IN_MSK+xLocal*K1_Local-yLocal*K2_Local}
function convertLocalToMskY(xLocal,yLocal,X0_Local_IN_MSK,Y0_Local_IN_MSK,K1_Local,K2_Local){if(isNaN(xLocal)||isNaN(yLocal))return NaN;return Y0_Local_IN_MSK+xLocal*K2_Local+yLocal*K1_Local}
function parseCSV(csvText){const lines=csvText.trim().split('\n');return lines.map((line,index)=>{const cleanedLine=line.trim();if(!cleanedLine)return null;const parts=cleanedLine.split(',');if(parts.length>=6){return{id:`gs_${index+1}`,fields:{CoordSystem:parts[COL_INDEX.CoordSystem]?.trim().toUpperCase()||'UNKNOWN',Point:parts[COL_INDEX.Point]?.trim()||'',[BASE_X_FIELD_NAME]:parts[COL_INDEX.Xraw]?.trim()||'',[BASE_Y_FIELD_NAME]:parts[COL_INDEX.Yraw]?.trim()||'',H:parts[COL_INDEX.H]?.trim()||'',Info:parts[COL_INDEX.Info]?.trim()||''}}}
console.warn(`Skipping malformed CSV line ${index+1}: ${line}`);return null}).filter(record=>record!==null)}
function transformCoordinates(inputX,inputY,sourceSystemLowercase,targetSystemLowercase){if(isNaN(inputX)||isNaN(inputY)){return{x:NaN,y:NaN}}if(sourceSystemLowercase===targetSystemLowercase){return{x:inputX,y:inputY}}let xMsk,yMsk;switch(sourceSystemLowercase){case'msk':xMsk=inputX;yMsk=inputY;break;case'izp':xMsk=convertLocalToMskX(inputX,inputY,X0_SS_IN_MSK,Y0_SS_IN_MSK,K1_SS,K2_SS);yMsk=convertLocalToMskY(inputX,inputY,X0_SS_IN_MSK,Y0_SS_IN_MSK,K1_SS,K2_SS);break;case'gfu':xMsk=convertLocalToMskX(inputX,inputY,X0_GFU_IN_MSK,Y0_GFU_IN_MSK,K1_GFU,K2_GFU);yMsk=convertLocalToMskY(inputX,inputY,X0_GFU_IN_MSK,Y0_GFU_IN_MSK,K1_GFU,K2_GFU);break;default:console.warn(`Transform: Unknown source system '${sourceSystemLowercase}'`);return{x:NaN,y:NaN}}if(isNaN(xMsk)||isNaN(yMsk)){return{x:NaN,y:NaN}}switch(targetSystemLowercase){case'msk':return{x:xMsk,y:yMsk};case'izp':return{x:convertMskToLocalX(xMsk,yMsk,X0_SS_IN_MSK,Y0_SS_IN_MSK,K1_SS,K2_SS),y:convertMskToLocalY(xMsk,yMsk,X0_SS_IN_MSK,Y0_SS_IN_MSK,K1_SS,K2_SS)};case'gfu':return{x:convertMskToLocalX(xMsk,yMsk,X0_GFU_IN_MSK,Y0_GFU_IN_MSK,K1_GFU,K2_GFU),y:convertMskToLocalY(xMsk,yMsk,X0_GFU_IN_MSK,Y0_GFU_IN_MSK,K1_GFU,K2_GFU)};default:console.warn(`Transform: Unknown target system '${targetSystemLowercase}'`);return{x:NaN,y:NaN}}}
function getCoordsInTargetMode(recordFields,targetModeLowercase){const xBaseRaw=recordFields[BASE_X_FIELD_NAME];const yBaseRaw=recordFields[BASE_Y_FIELD_NAME];const sourceSystemUppercase=recordFields['CoordSystem'];const xBase=parseFloat(xBaseRaw);const yBase=parseFloat(yBaseRaw);return transformCoordinates(xBase,yBase,sourceSystemUppercase.toLowerCase(),targetModeLowercase)}
function updateManualConversion(){if(!manualCoordXInput||!manualCoordYInput||!manualResultXSpan||!manualResultYSpan){return}const sourceSystem=document.querySelector('input[name="manual-source-system"]:checked').value;const targetSystem=document.querySelector('input[name="manual-target-system"]:checked').value;const inputXValue=manualCoordXInput.value.trim().replace(',','.');const inputYValue=manualCoordYInput.value.trim().replace(',','.');if(inputXValue===''||inputYValue===''){manualResultXSpan.textContent='---';manualResultYSpan.textContent='---';return}const inputX=parseFloat(inputXValue);const inputY=parseFloat(inputYValue);const result=transformCoordinates(inputX,inputY,sourceSystem,targetSystem);manualResultXSpan.textContent=formatCoordinate(result.x);manualResultYSpan.textContent=formatCoordinate(result.y)}

function displayRecords(records) {
    outputContainer.innerHTML = '';
    if (isLoading) {
        messageState.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
        messageState.style.display = 'block';
        outputContainer.style.display = 'none';
        messageState.classList.remove('error');
        return;
    }
    if (records.length === 0) {
        if (fullDatabaseCache.length === 0) messageState.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞.';
        else if (searchInput.value.trim() === '') messageState.textContent = `–°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...`;
        else messageState.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.';
        messageState.style.display = 'block';
        outputContainer.style.display = 'none';
        messageState.classList.remove('error');
        return;
    }
    messageState.style.display = 'none';
    outputContainer.style.display = 'block';
    const fragment = document.createDocumentFragment();
    records.forEach(record => {
        const point = record.fields['Point'] || 'N/A';
        const info = record.fields['Info'] || 'N/A';
        const h = record.fields['H'] || 'N/A';
        const targetCoords = getCoordsInTargetMode(record.fields, currentCoordMode);
        const formattedX = formatCoordinate(targetCoords.x);
        const formattedY = formatCoordinate(targetCoords.y);
        const formattedH = formatCoordinate(h);
        let outputStringPart = `${currentSeparatorChar}${formattedX}${currentSeparatorChar}${formattedY}${currentSeparatorChar}${formattedH}${currentSeparatorChar}`;
        if (isNoteVisible) {
            outputStringPart += info;
        }
        const lineDiv = document.createElement('div');
        lineDiv.className = 'output-line';
        const pointLink = document.createElement('a');
        pointLink.textContent = point;
        pointLink.className = 'point-link';
        pointLink.href = '#';
        pointLink.dataset.id = record.id;
        lineDiv.appendChild(pointLink);
        lineDiv.appendChild(document.createTextNode(outputStringPart));

        // --- –ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è Google Maps ---
        if (typeof proj4 !== 'undefined') {
            const mskCoords = getCoordsInTargetMode(record.fields, 'msk');
            if (!isNaN(mskCoords.x) && !isNaN(mskCoords.y)) {
                const sk42_x = mskCoords.x; // –°–µ–≤–µ—Ä
                const sk42_y = mskCoords.y + 18000000; // –í–æ—Å—Ç–æ–∫ –¥–ª—è –∑–æ–Ω—ã 18

                try {
                    // Proj4 –æ–∂–∏–¥–∞–µ—Ç [–≤–æ—Å—Ç–æ–∫, —Å–µ–≤–µ—Ä] –¥–ª—è EPSG:28418 (—Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é AXIS)
                    // –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞] –¥–ª—è EPSG:4326
                    const wgsCoords = proj4("EPSG:28418", "EPSG:4326", [sk42_y, sk42_x]);
                    const lat = wgsCoords[1]; // –®–∏—Ä–æ—Ç–∞
                    const lon = wgsCoords[0]; // –î–æ–ª–≥–æ—Ç–∞

                    const gmapsButton = document.createElement('a');
                    gmapsButton.href = `https://www.google.com/maps?q=${lat},${lon}`;
                    gmapsButton.textContent = 'üó∫Ô∏è';
                    gmapsButton.target = '_blank'; // –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    gmapsButton.style.marginLeft = '8px'; // –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
                    gmapsButton.style.textDecoration = 'none'; // –£–±—Ä–∞—Ç—å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
                    lineDiv.appendChild(gmapsButton);
                } catch (e) {
                    console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è Google Maps (—Ç–æ—á–∫–∞ ${point}):`, e);
                    const errorSpan = document.createElement('span');
                    errorSpan.textContent = ' (–æ—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã)';
                    errorSpan.style.fontSize = '0.8em';
                    errorSpan.style.color = 'red';
                    errorSpan.style.marginLeft = '5px';
                    lineDiv.appendChild(errorSpan);
                }
            } else {
                 console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ú–°–ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ç–æ—á–∫–∏ ${point} –¥–ª—è Google Maps.`);
                 const errorSpan = document.createElement('span');
                 errorSpan.textContent = ' (–Ω–µ—Ç –ú–°–ö)';
                 errorSpan.style.fontSize = '0.8em';
                 errorSpan.style.color = 'orange';
                 errorSpan.style.marginLeft = '5px';
                 lineDiv.appendChild(errorSpan);
            }
        } else {
            // –ï—Å–ª–∏ proj4 –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const errorSpan = document.createElement('span');
            errorSpan.textContent = ' (–∫–∞—Ä—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)';
            errorSpan.style.fontSize = '0.8em';
            errorSpan.style.color = 'grey';
            errorSpan.style.marginLeft = '5px';
            lineDiv.appendChild(errorSpan);
        }
        // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è Google Maps ---

        fragment.appendChild(lineDiv);
    });
    outputContainer.appendChild(fragment);
}

function performSearch(){if(isLoading)return;const searchTerm=searchInput.value.trim();const searchModeToggle=document.querySelector('.search-mode-toggle input[name="search-mode"]:checked');const ignoreCharsToggle=document.querySelector('.ignore-chars-toggle input[name="ignore-mode"]:checked');shouldIgnoreChars=ignoreCharsToggle?ignoreCharsToggle.value==='on':!1;const searchMode=searchModeToggle?searchModeToggle.value:'contains';if(!searchTerm){currentDisplayRecords=[];displayRecords(currentDisplayRecords);return}messageState.textContent='–ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ...';messageState.style.display='block';outputContainer.style.display='none';messageState.classList.remove('error');const queryForComparison=shouldIgnoreChars?normalizePointValue(searchTerm):searchTerm.toLowerCase();currentDisplayRecords=fullDatabaseCache.filter(record=>{const rawFieldValue=record.fields['Point'];if(!rawFieldValue)return!1;const fieldValueForComparison=shouldIgnoreChars?normalizePointValue(rawFieldValue):rawFieldValue.toLowerCase();return searchMode==='exact'?fieldValueForComparison===queryForComparison:String(fieldValueForComparison).includes(String(queryForComparison))});displayRecords(currentDisplayRecords)}
function findAndShowNearby(clickedRecordId){const referencePoint=fullDatabaseCache.find(r=>r.id===clickedRecordId);if(!referencePoint){console.error("Ref point not found:",clickedRecordId);return}const refCoords=getCoordsInTargetMode(referencePoint.fields,currentCoordMode);if(isNaN(refCoords.x)||isNaN(refCoords.y)){alert(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: —É —Ç–æ—á–∫–∏ (${referencePoint.fields['Point']}) –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ ${currentCoordMode}. –ò—Å—Ö–æ–¥–Ω–∞—è: ${referencePoint.fields['CoordSystem']}`);return}const refX=refCoords.x;const refY=refCoords.y;const nearbyPoints=[];fullDatabaseCache.forEach(candidateRecord=>{if(candidateRecord.id===clickedRecordId)return;const candCoords=getCoordsInTargetMode(candidateRecord.fields,currentCoordMode);if(isNaN(candCoords.x)||isNaN(candCoords.y))return;const deltaX=candCoords.x-refX;const deltaY=candCoords.y-refY;const distance=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(distance<=MAX_NEARBY_DISTANCE){nearbyPoints.push({record:candidateRecord,distance:distance,calculatedX:candCoords.x,calculatedY:candCoords.y})}});nearbyPoints.sort((a,b)=>a.distance-b.distance);nearbyListContainer.innerHTML='';const refPointData=referencePoint.fields;let refOutputString=`${refPointData['Point']||'N/A'}${currentSeparatorChar}${formatCoordinate(refX)}${currentSeparatorChar}${formatCoordinate(refY)}${currentSeparatorChar}${formatCoordinate(refPointData['H'])}${currentSeparatorChar}`;if(isNoteVisible)refOutputString+=(refPointData['Info']||'N/A');const refElement=document.createElement('div');refElement.className='reference-point';refElement.innerHTML=`<strong>–ò—Å—Ö–æ–¥–Ω–∞—è:</strong> ${refOutputString}`;nearbyListContainer.appendChild(refElement);if(nearbyPoints.length>0){nearbyPoints.forEach(item=>{const rd=item.record.fields;let outStr=`${rd['Point']||'N/A'}${currentSeparatorChar}${formatCoordinate(item.calculatedX)}${currentSeparatorChar}${formatCoordinate(item.calculatedY)}${currentSeparatorChar}${formatCoordinate(rd['H'])}${currentSeparatorChar}`;if(isNoteVisible)outStr+=(rd['Info']||'N/A');const li=document.createElement('div');li.className='nearby-item';li.innerHTML=`<span class="nearby-distance">(${item.distance.toFixed(1)})</span> ${outStr}`;nearbyListContainer.appendChild(li)})}else{const noNearbyDiv=document.createElement('div');noNearbyDiv.textContent='–ë–ª–∏–∂–∞–π—à–∏–µ —Ç–æ—á–∫–∏ (–¥–æ 300–º) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';nearbyListContainer.appendChild(noNearbyDiv)}nearbyPopup.style.display='flex'}
function closeNearbyPopup(){nearbyPopup.style.display='none';nearbyListContainer.innerHTML=''}
async function fetchAllRecords(){isLoading=!0;messageState.textContent='–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';outputContainer.style.display='none';messageState.classList.remove('error');fullDatabaseCache=[];try{const nocacheUrl=`${GOOGLE_SHEET_CSV_URL}&_=${Date.now()}`;const response=await fetch(nocacheUrl);if(!response.ok)throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV: ${response.status}`);const csvText=await response.text();fullDatabaseCache=parseCSV(csvText);isLoading=!1;currentDisplayRecords=[];displayRecords(currentDisplayRecords)}catch(error){isLoading=!1;messageState.textContent=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å.`;messageState.classList.add('error');messageState.style.display='block'}}
document.addEventListener('DOMContentLoaded',()=>{const searchModeToggleButtons=document.querySelectorAll('.search-mode-toggle input[name="search-mode"]');const noteToggleButtons=document.querySelectorAll('.note-toggle input[name="note-mode"]');const ignoreCharsToggleButtons=document.querySelectorAll('.ignore-chars-toggle input[name="ignore-mode"]');const separatorToggleButtons=document.querySelectorAll('.separator-toggle input[name="separator-mode"]');closePopupButton=document.querySelector('.popup-close-btn');searchInput.addEventListener('input',()=>{clearTimeout(debounceTimer);debounceTimer=setTimeout(performSearch,DEBOUNCE_DELAY)});searchModeToggleButtons.forEach(r=>r.addEventListener('change',()=>{if(searchInput.value.trim())performSearch()}));searchCoordToggleButtons.forEach(r=>r.addEventListener('change',(e)=>{currentCoordMode=e.target.value;displayRecords(currentDisplayRecords)}));noteToggleButtons.forEach(r=>r.addEventListener('change',(e)=>{isNoteVisible=e.target.value==='on';displayRecords(currentDisplayRecords)}));ignoreCharsToggleButtons.forEach(r=>r.addEventListener('change',()=>{if(searchInput.value.trim())performSearch()}));separatorToggleButtons.forEach(r=>r.addEventListener('change',(e)=>{currentSeparatorChar=e.target.value==='space'?' ':',';displayRecords(currentDisplayRecords)}));outputContainer.addEventListener('click',(e)=>{if(e.target.classList.contains('point-link')){e.preventDefault();const recordId=e.target.dataset.id;if(recordId)findAndShowNearby(recordId);else console.error("No record ID on link.")}});if(nearbyPopup){nearbyPopup.addEventListener('click',(e)=>{if(e.target===nearbyPopup)closeNearbyPopup()})}if(closePopupButton){closePopupButton.addEventListener('click',closeNearbyPopup)}manualSourceSystemRadios=document.querySelectorAll('input[name="manual-source-system"]');manualTargetSystemRadios=document.querySelectorAll('input[name="manual-target-system"]');manualCoordXInput=document.getElementById('manual-coord-x');manualCoordYInput=document.getElementById('manual-coord-y');manualResultXSpan=document.getElementById('manual-conversion-result-x');manualResultYSpan=document.getElementById('manual-conversion-result-y');manualSourceSystemRadios.forEach(radio=>radio.addEventListener('change',updateManualConversion));manualTargetSystemRadios.forEach(radio=>radio.addEventListener('change',updateManualConversion));manualCoordXInput.addEventListener('input',updateManualConversion);manualCoordYInput.addEventListener('input',updateManualConversion);fetchAllRecords();updateManualConversion()});
</script>
</html>
